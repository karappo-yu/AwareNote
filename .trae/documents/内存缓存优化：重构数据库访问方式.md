# 内存缓存优化重构计划

## 优化目标
- 将分类树缓存到内存中，避免每次查询都访问数据库
- 只在扫描时更新缓存，访问时直接从内存读取
- 大幅提高 API 响应速度和系统性能

## 实现步骤

### 1. 添加缓存管理机制
- 在 `database/db.py` 中添加全局缓存变量 `_category_tree_cache`
- 添加 `clear_cache()` 方法清空缓存
- 添加 `build_cache()` 方法从数据库构建缓存

### 2. 重构数据库访问方法
- **`get_all_categories()`**: 直接返回缓存中的根分类
- **`get_category_by_id()`**: 从缓存中递归查找分类
- **`get_category_children()`**: 从缓存中获取子分类
- **`get_category_books()`**: 从缓存中获取书籍

### 3. 同步缓存与扫描过程
- 在 `app.py` 的 `sync_data()` 函数中，扫描完成后调用 `build_cache()` 更新缓存
- 确保扫描过程会清空旧缓存并创建新缓存

### 4. 保持自定义分类功能
- 自定义分类相关方法保持不变，继续访问数据库
- 因为自定义分类是运行时修改的数据，不适合缓存

### 5. 代码清理
- 移除 `_build_category_tree` 方法中的数据库访问代码
- 简化 `db.py` 中的分类相关方法，使其只操作内存缓存

## 技术亮点
- **零数据库查询**: 正常访问时完全不访问数据库
- **实时同步**: 扫描时自动更新缓存
- **内存优化**: 只缓存必要的数据结构
- **向后兼容**: API 接口保持不变
- **性能提升**: 响应速度从毫秒级降至微秒级

## 预期效果
- **API 响应时间**: 减少 99% 以上
- **数据库负载**: 几乎为零
- **系统稳定性**: 大幅提高
- **用户体验**: 响应速度极快，无延迟感