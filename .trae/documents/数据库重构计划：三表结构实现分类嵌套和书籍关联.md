# 数据库重构计划

## 重构目标

将当前的两表结构（books 和 categories）重构为三表结构，使用通用关系表来管理分类嵌套和书籍关联关系。

## 重构步骤

### 1. 修改数据库表结构

* **保留 books 表**：保持现有结构不变

* **简化 categories 表**：移除 sub\_categories 和 books 字段

* **新增 entity\_relations 表**：存储分类与分类、分类与书籍的关系

### 2. 更新数据库操作代码 (database/db.py)

* 修改 `_init_db` 方法：创建新的表结构

* 更新分类相关方法：

  * `add_category`：不再存储子分类和书籍

  * `update_category`：不再更新子分类和书籍

  * 新增 `add_entity_relation`：添加关系

  * 新增 `remove_entity_relation`：移除关系

  * 新增 `get_category_children`：获取分类的子分类

  * 新增 `get_category_books`：获取分类的书籍

  * 修改 `get_all_categories`：使用关系表构建嵌套结构

  * 修改 `get_category_by_id`：使用关系表构建嵌套结构

### 3. 修改扫描器代码 (scanner/scanner.py)

* 修改 `scan_dir` 方法：不再构建嵌套分类结构，而是创建扁平分类

* 修改 `scan` 方法：扫描完成后，创建分类与分类、分类与书籍的关系

### 4. 修改 API 路由代码

* 更新 `category.py` 路由：

  * 修改 `get_categories`：返回嵌套分类结构

  * 修改 `get_category`：返回分类及其子分类和书籍

  * 修改 `get_category_books`：使用新的数据库方法

### 5. 测试验证

* 运行扫描器，确保数据正确入库

* 测试 API 接口，确保分类和书籍数据正确返回

* 验证分类嵌套结构是否正确显示

* 验证分类与书籍的关联是否正确

## 预期效果

* 更清晰的数据结构，易于管理

* 支持无限层级的分类嵌套

* 更灵活的分类与书籍关联管理

* 更好的查询性能，避免 JSON 解析开销

* 更易于扩展，可支持新的关系类型

## 注意事项

* 由于不需要数据迁移，重构后需要重新运行扫描器导入数据

* 确保所有 API 接口保持向后兼容

* 确保前端代码能够正确处理新的数据结构

