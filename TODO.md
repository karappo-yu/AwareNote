# 项目优化任务清单

## Scanner 模块优化

### 任务描述
**优化点**：将scanner的scan方法重构为按文件类型单独扫描的逻辑，提高性能和可维护性

### 项目现状分析
- **当前结构**：scanner/scanner.py 包含所有扫描逻辑，混合处理PDF和图片文件
- **现有功能**：
  - 递归扫描目录结构
  - 自动识别PDF文件和图片文件夹
  - 提取文件元数据（PDF页数、图片尺寸等）
  - 生成稳定的UUID标识
  - 分析文件尺寸并设置优化策略
  - 构建分类和书籍的层级结构

### 具体实现要求

#### 1. 文件类型处理器模式
- 创建统一的文件类型处理器接口 `FileTypeHandler`
- 实现具体处理器：
  - `PDFHandler`：专门处理PDF文件，复用现有的 `create_pdf_book` 逻辑
  - `ImageHandler`：专门处理图片文件夹，复用现有的 `create_image_book` 逻辑
  - 预留 `EpubHandler`、`CbzHandler` 等扩展接口

#### 2. 并行扫描实现
- 使用 `ThreadPoolExecutor` 实现不同文件类型的并行扫描
- 充分利用多核CPU性能，提高扫描速度
- 实现任务队列和结果合并机制

#### 3. 模块化结构设计
```
scanner/
├── __init__.py
├── base.py          # 基础接口和工具类
├── handlers/        # 各种文件类型处理器
│   ├── __init__.py
│   ├── pdf_handler.py
│   ├── image_handler.py
│   └── epub_handler.py  # 未来扩展
├── coordinator.py   # 扫描协调器，管理处理器和并行任务
└── utils/           # 工具函数
    ├── __init__.py
    ├── metadata.py  # 元数据提取（复用现有分析函数）
    └── cache.py     # 缓存工具（基于现有的 cache_utils.py）
```

#### 4. 缓存机制优化
- 基于现有的 `utils/cache_utils.py` 实现LRU缓存
- 缓存文件元数据（PDF页数、图片尺寸等）
- 缓存扫描结果，避免重复扫描
- 设置合理的缓存过期策略

#### 5. 配置驱动增强
- 基于现有的 `config/config.py` 管理文件类型和扫描规则
- 支持通过配置文件添加新的文件类型
- 支持自定义扫描策略和阈值
- 实现配置热加载

#### 6. 错误隔离与处理
- 每个处理器独立处理错误，不影响其他类型
- 提供详细的错误信息和日志
- 实现错误重试机制
- 支持错误统计和报告

#### 7. 事件驱动机制
- 实现扫描事件系统，提供实时进度反馈
- 支持事件类型：
  - 扫描开始/结束事件
  - 文件处理开始/结束事件
  - 错误事件
  - 进度更新事件
- 支持事件监听器注册和移除

#### 8. 与现有模块集成
- 与 `models/book.py` 和 `models/category.py` 无缝集成
- 与 `utils/image_utils.py` 和 `utils/pdf_utils.py` 协作
- 与 `database/db.py` 配合，支持扫描结果的持久化
- 与 `routers/book.py` 和 `routers/category.py` 集成，提供API接口

### 性能和可维护性目标

#### 1. 性能提升
- 扫描速度提升30%以上（通过并行处理）
- 内存使用优化20%（通过缓存和惰性加载）
- 响应时间缩短50%（通过事件驱动和异步处理）
- 支持更大规模的文件系统扫描

#### 2. 可维护性提升
- 代码可读性提高（模块化设计）
- 代码复用率提高30%（处理器模式）
- 测试覆盖率提高（单元测试友好的设计）
- 文档完善度提高（接口文档和使用说明）

#### 3. 扩展性提升
- 支持插件机制动态添加新的文件类型处理器
- 支持自定义扫描规则和策略
- 支持事件机制扩展扫描过程
- 支持配置文件驱动的功能开关

### 实现步骤

#### 阶段一：基础架构搭建
1. **创建模块化目录结构**：scanner/handlers/ 和 scanner/utils/
2. **实现基础接口**：scanner/base.py 中的 FileTypeHandler 接口
3. **实现扫描协调器**：scanner/coordinator.py

#### 阶段二：核心功能实现
4. **实现PDF处理器**：scanner/handlers/pdf_handler.py
5. **实现图片处理器**：scanner/handlers/image_handler.py
6. **实现并行扫描逻辑**：基于 ThreadPoolExecutor
7. **集成缓存机制**：基于现有的 cache_utils.py

#### 阶段三：增强功能
8. **实现事件系统**：扫描事件的定义和处理
9. **优化配置驱动**：支持自定义文件类型和规则
10. **实现错误处理机制**：错误隔离和重试

#### 阶段四：集成与测试
11. **与现有模块集成**：更新相关依赖
12. **编写单元测试**：覆盖核心功能
13. **性能测试与优化**：测量并优化扫描速度
14. **文档编写**：接口文档和使用说明

### 预期效果

#### 功能层面
- **更快的扫描速度**：并行处理多个文件类型
- **更准确的文件识别**：专门的处理器针对特定文件类型优化
- **更丰富的元数据**：每个处理器可以提取更详细的文件信息
- **更稳定的扫描过程**：错误隔离机制提高可靠性

#### 开发层面
- **更清晰的代码结构**：模块化设计，职责分离
- **更容易添加新功能**：插件机制支持扩展
- **更好的可测试性**：单元测试友好的设计
- **更完善的文档**：接口文档和使用说明

#### 用户层面
- **实时的扫描进度**：事件驱动提供即时反馈
- **详细的错误信息**：便于排查问题
- **可配置的扫描行为**：适应不同用户需求
- **支持更多文件格式**：易于扩展支持新格式

### 技术要点

1. **设计模式**：使用策略模式、观察者模式、工厂模式
2. **并发处理**：ThreadPoolExecutor、任务队列
3. **缓存策略**：LRU缓存、缓存过期
4. **事件系统**：发布-订阅模式
5. **配置管理**：分层配置、热加载
6. **错误处理**：异常隔离、重试机制
7. **性能优化**：惰性加载、批处理
8. **测试策略**：单元测试、集成测试、性能测试

### 风险评估

1. **并行处理风险**：文件系统并发访问可能导致性能瓶颈
   - **缓解措施**：实现合理的并发控制和任务调度

2. **缓存一致性风险**：缓存过期策略可能导致数据不一致
   - **缓解措施**：实现基于文件修改时间的缓存失效机制

3. **扩展性风险**：接口设计可能限制未来扩展
   - **缓解措施**：采用松耦合设计，预留扩展点

4. **兼容性风险**：重构可能破坏现有功能
   - **缓解措施**：保持API兼容性，编写充分的测试用例

5. **性能退化风险**：某些场景下性能可能不如原有实现
   - **缓解措施**：实现性能监控和回退机制

### 成功指标

1. **功能完整性**：所有现有功能正常工作
2. **性能提升**：扫描速度达到预期目标
3. **代码质量**：通过代码审查和静态分析
4. **测试覆盖率**：核心功能测试覆盖率达到80%以上
5. **文档完善度**：提供完整的接口文档和使用说明
6. **用户反馈**：扫描过程更加流畅，反馈更及时

### 后续扩展建议

1. **支持更多文件格式**：EPUB、CBZ、漫画等
2. **实现增量扫描**：只扫描修改的文件
3. **添加智能分类**：基于文件内容和元数据的自动分类
4. **实现远程扫描**：支持网络文件系统和云存储
5. **添加扫描计划**：定时自动扫描功能
